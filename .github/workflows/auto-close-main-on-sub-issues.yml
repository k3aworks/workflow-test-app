name: Auto-close main issue when all sub-issues are done

on:
  issues:
    types: [closed, reopened]

permissions:
  issues: write

jobs:
  auto-close-main:
    runs-on: ubuntu-latest

    steps:
      - name: Auto-close or reopen main issue based on sub-issues
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;
            const title = issue.title || "";

            // We only care about sub-issues with titles like "Sub 1.4 - ..."
            const match = title.match(/^Sub\s+(\d+)\./);
            if (!match) {
              core.info("Not a Sub N.x issue, nothing to do.");
              return;
            }

            const mainIndex = match[1];
            const { owner, repo } = context.repo;

            // Helper: find the main issue "Main <N> - ..." (open or closed)
            async function findMainIssue() {
              const allIssues = await github.paginate(
                github.rest.issues.listForRepo,
                { owner, repo, state: "all", per_page: 100 }
              );

              return allIssues.find(i => i.title.startsWith(`Main ${mainIndex} `));
            }

            if (action === "closed") {
              // When a sub-issue closes, check if any other Sub N.* issues are still open.
              const openIssues = await github.paginate(
                github.rest.issues.listForRepo,
                { owner, repo, state: "open", per_page: 100 }
              );

              const openSubs = openIssues.filter(i =>
                /^Sub\s+\d+\./.test(i.title) &&
                i.title.startsWith(`Sub ${mainIndex}.`)
              );

              if (openSubs.length > 0) {
                core.info(`There are still ${openSubs.length} open Sub ${mainIndex}.x issues; not closing main.`);
                return;
              }

              const main = await findMainIssue();
              if (!main) {
                core.info(`No main issue found for Main ${mainIndex}.x`);
                return;
              }

              if (main.state === "open") {
                core.info(`Closing main issue #${main.number} because all Sub ${mainIndex}.x issues are closed.`);
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: main.number,
                  state: "closed",
                });

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: main.number,
                  body: `Auto-closing this main issue because all related Sub ${mainIndex}.x issues are closed.`,
                });
              } else {
                core.info(`Main issue #${main.number} is already closed.`);
              }
            } else if (action === "reopened") {
              // Optional: if a sub-issue is reopened and the main is closed, reopen the main.
              const main = await findMainIssue();
              if (!main) {
                core.info(`No main issue found for Main ${mainIndex}.x`);
                return;
              }

              if (main.state === "closed") {
                core.info(`Reopening main issue #${main.number} because a Sub ${mainIndex}.x issue was reopened.`);
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: main.number,
                  state: "open",
                });

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: main.number,
                  body: `Reopening this main issue because one of its Sub ${mainIndex}.x issues was reopened.`,
                });
              } else {
                core.info(`Main issue #${main.number} is already open.`);
              }
            } else {
              core.info(`Unhandled action: ${action}`);
            }
